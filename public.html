<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>WipeWeb — Public Group</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Share+Tech+Mono&display=swap');
        :root {
            --bg: #0A0D0B; --panel: #0E1311; --soft: #141A17; --line: #1A2B21;
            --neon: #10FF6A; --ink: #E8FFE8; --muted: #A6F1BF; --danger: #FF6B6B;
            --shadow: 0 10px 30px rgba(16, 255, 106, .08);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--ink);
            display: flex;
            flex-direction: column;
        }
        .app-shell {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 12px;
            gap: 12px;
        }
        header {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .chip {
            border: 1px dashed #1E6F46;
            background: #0F1A14;
            color: #DFFFE9;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
        }
        .spacer { flex: 1; }
        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 14px;
            box-shadow: var(--shadow);
        }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid #1E6F46;
            background: #0F1A14;
            word-break: break-word;
            line-height: 1.4;
        }
        .me {
            align-self: flex-end;
            background: #11281C;
            border-color: #2AD072;
        }
        .meta { font-size: 11px; color: #97EEB8; margin-top: 4px; opacity: 0.8; }
        .sys { align-self: center; color: #9FE8BD; font-size: 12px; }
        .composer {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--line);
        }
        .btn {
            background: #102019;
            color: #CAFFD8;
            border: 1px solid #1E6F46;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn.primary {
            background: linear-gradient(180deg, #10FF6A 0%, #0EDF5B 100%);
            color: #072010;
            border-color: #10FF6A;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type="text"] {
            flex: 1;
            background: var(--soft);
            border: 1px solid var(--line);
            color: #EAFFE8;
            border-radius: 10px;
            padding: 12px;
            outline: none;
        }
        a.link { color: #8DFFC3; text-decoration: underline; }
        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: max(16px, calc(env(safe-area-inset-bottom) + 12px));
            background: #10241A;
            color: #B8FFD3;
            border: 1px solid #1E6F46;
            padding: 10px 14px;
            border-radius: 10px;
            opacity: 0;
            transition: .25s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="app-shell">
        <header>
            <span class="chip" id="cAnon">Anon: —</span>
            <span class="chip" id="cRoom">Room: —</span>
            <div class="spacer"></div>
            <button class="btn" onclick="location.href='index.html'">Home</button>
        </header>

        <div class="card">
            <div style="display:flex; gap: 8px; align-items: center;">
                <input id="roomName" type="text" placeholder="Group name (optional)" />
                <button id="btnCreate" class="btn primary">Create Group</button>
                <input id="shareURL" type="text" readonly placeholder="Group Share URL" style="flex: 2;"/>
                <button id="btnCopy" class="btn">Copy</button>
            </div>
        </div>

        <div class="card main-chat">
            <div class="chat-history" id="chat"></div>
            <div class="composer">
                <input id="msg" type="text" placeholder="Type message..." disabled />
                <input id="file" type="file" style="display:none" />
                <button id="btnFile" class="btn" disabled>Attach</button>
                <button id="btnSend" class="btn primary" disabled>Send</button>
            </div>
            <div style="font-size: 12px; color: var(--muted); padding-top: 6px;">Max file size: 1MB</div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
        const BACKEND_BASE = 'https://frontend-1-23zz.onrender.com';
        const API = {
            anon: BACKEND_BASE + '/v1/anon/new',
            publicCreate: (anon) => BACKEND_BASE + '/v1/public/create?anon_id=' + anon,
            publicJoin: (rid) => BACKEND_BASE + '/v1/public/join?room_id=' + rid,
            list: (rid) => BACKEND_BASE + `/v1/messages/list?room_id=${rid}&limit=100`,
            post: (rid) => BACKEND_BASE + '/v1/messages/post?room_id=' + rid,
            upload: (rid) => BACKEND_BASE + '/v1/files/upload?room_id=' + rid,
            fileGet: (path) => BACKEND_BASE + path,
        };

        const qs = new URLSearchParams(location.search);
        let anonId = qs.get('anon_id');
        let roomId = qs.get('room_id');
        let poll = null;

        const $ = (id) => document.getElementById(id);
        const toast = (msg) => {
            const el = $('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1500);
        };

        function setChips() {
            $('cAnon').textContent = 'Anon: ' + (anonId || '—');
            $('cRoom').textContent = 'Room: ' + (roomId || '—');
        }

        function enableChat(state) {
            $('msg').disabled = !state;
            $('btnSend').disabled = !state;
            $('btnFile').disabled = !state;
        }
        
        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s<]+)/g;
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                       .replace(urlRegex, '<a href="$1" target="_blank" rel="noopener" class="link">$1</a>');
        }

        function renderMessage(m) {
            const isMe = m.sender_anon_id === anonId;
            const bubble = document.createElement('div');
            bubble.className = 'bubble' + (isMe ? ' me' : '');
            
            let contentHTML = '';
            if (m.msg_type === 'file') {
                contentHTML = `<div><a href="${API.fileGet(m.content)}" target="_blank" rel="noopener" class="link">Download File</a></div>`;
            } else {
                contentHTML = `<div>${linkify(m.content)}</div>`;
            }
            
            bubble.innerHTML = `${contentHTML}<div class="meta">${isMe ? 'You' : m.sender_anon_id}</div>`;
            $('chat').appendChild(bubble);
            $('chat').scrollTop = $('chat').scrollHeight;
        }

        async function fetchMessages() {
            if (!roomId) return;
            const res = await fetch(API.list(roomId));
            if (!res.ok) return;
            const messages = await res.json();
            $('chat').innerHTML = '';
            messages.forEach(renderMessage);
        }

        function startPolling() {
            stopPolling();
            fetchMessages();
            poll = setInterval(fetchMessages, 2000);
        }
        function stopPolling() {
            if (poll) clearInterval(poll);
            poll = null;
        }

        async function init() {
            setChips();
            if (!anonId) {
                const res = await fetch(API.anon);
                const data = await res.json();
                anonId = data.id;
                setChips();
                const url = new URL(location.href);
                url.searchParams.set('anon_id', anonId);
                history.replaceState({}, '', url);
            }

            if (roomId) {
                const res = await fetch(API.publicJoin(roomId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ anon_id: anonId })
                });
                if (res.ok) {
                    toast('Joined group!');
                    enableChat(true);
                    startPolling();
                } else {
                    toast('Failed to join group.');
                }
            } else {
                 $('chat').innerHTML = '<div class="sys">Create a group to start chatting.</div>';
            }
        }

        $('btnCreate').addEventListener('click', async () => {
            const res = await fetch(API.publicCreate(anonId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: $('roomName').value || null })
            });
            if (!res.ok) {
                toast('Failed to create group.');
                return;
            }
            const data = await res.json();
            roomId = data.room_id;
            $('shareURL').value = data.share_url;
            setChips();
            enableChat(true);
            startPolling();
            toast('Group created and joined!');
        });

        $('btnCopy').addEventListener('click', () => {
            const url = $('shareURL').value;
            if (url) {
                navigator.clipboard.writeText(url);
                toast('Link copied!');
            }
        });
        
        $('btnSend').addEventListener('click', async () => {
            const content = $('msg').value.trim();
            if (!content || !roomId) return;
            const res = await fetch(API.post(roomId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ anon_id: anonId, msg_type: 'text', content })
            });
            if (res.ok) {
                $('msg').value = '';
                fetchMessages();
            } else {
                toast('Failed to send message.');
            }
        });

        $('btnFile').addEventListener('click', () => $('file').click());
        $('file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) {
                toast('File is too large (max 1MB).');
                return;
            }
            const formData = new FormData();
            formData.append('anon_id', anonId);
            formData.append('f', file);
            
            const res = await fetch(API.upload(roomId), {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                toast('File uploaded!');
                fetchMessages();
            } else {
                toast('Upload failed. Ensure you are in a room.');
            }
        });
        
        init();
    </script>
</body>
</html>
