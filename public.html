<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>WipeWeb — Public Group</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap');
  :root{--bg:#080b09;--panel:#0e1310;--soft:#121714;--line:#1a2a21;--neon:#10ff6a;--ink:#e8ffe8;--muted:#a6f0bf;--danger:#ff6b6b}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 20% -10%, #04230f 0%, #080b09 40%, #000 100%);color:var(--ink);font-family:'Inter',system-ui;display:flex;flex-direction:column}
  header{position:sticky;top:0;z-index:5;background:rgba(10,13,10,.75);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px;display:flex;gap:10px;align-items:center}
  .chip{border:1px dashed #1e6f46;background:#0f1a14;color:#dfffe9;border-radius:10px;padding:6px 10px;font-size:12px}
  .spacer{flex:1}
  .wrap{padding:12px;display:flex;gap:12px;flex-direction:column;flex:1}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 10px 28px rgba(16,255,106,.12)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"]{flex:1;background:var(--soft);border:1px solid var(--line);color:#eaffe8;border-radius:10px;padding:12px}
  .btn{background:#102019;color:#caffd8;border:1px solid #1e6f46;padding:12px 14px;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#10ff6a 0%,#0edf5b 100%);color:#072010;border-color:#10ff6a}
  .btn:disabled{opacity:.5}
  .chatShell{display:flex;flex-direction:column;min-height:50vh;max-height:75vh}
  .chat{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;background:#0a0f0c;border-radius:12px;padding:12px;border:1px solid var(--line)}
  .composer{position:sticky;bottom:0;margin-top:8px;display:flex;gap:8px;align-items:center;background:transparent}
  .bub{max-width:85%;background:#0f1c15;border:1px solid #1e6f46;border-radius:12px;padding:10px 12px}
  .me{align-self:flex-end;background:#12251b;border-color:#2ad072}
  .meta{font-size:11px;color:#97eeb8;margin-top:4px}
  .sys{align-self:center;color:#9fe8bd;font-size:12px}
  .fileName{color:#b8ffd3}
  a.link{color:#8dffc3;text-decoration:underline}
  .hint{color:var(--muted);font-size:12px}
  .err{color:var(--danger);font-size:13px}
</style>
</head>
<body>
<header>
  <span class="chip" id="cAnon">Anon: —</span>
  <span class="chip" id="cRoom">Room: —</span>
  <div class="spacer"></div>
  <button class="btn" onclick="location.href='index.html'">Home</button>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <input id="roomName" placeholder="Group name (optional)"/>
      <button id="btnCreate" class="btn primary">Create Group</button>
      <input id="shareURL" readonly placeholder="Group share URL"/>
      <button id="btnCopy" class="btn">Share</button>
    </div>
    <div id="err" class="err"></div>
    <div class="hint" style="margin-top:6px">Groups allow up to 100 members. Share URL to auto-join.</div>
  </div>

  <div class="card chatShell">
    <div class="chat" id="chat"></div>
    <div class="composer">
      <input id="msg" type="text" placeholder="Type message and press Enter..." disabled/>
      <input id="file" type="file" style="display:none"/>
      <button id="btnFile" class="btn">Attach</button>
      <button id="btnSend" class="btn primary" disabled>Send</button>
      <button id="btnLeave" class="btn" disabled>Leave</button>
    </div>
    <div class="hint">Max file size: 1MB</div>
  </div>
</div>

<script>
const BACKEND_BASE='https://frontend-1-23zz.onrender.com';
const API={
  anon: BACKEND_BASE+'/v1/anon/new',
  publicCreate:(anon)=>BACKEND_BASE+'/v1/public/create?anon_id='+encodeURIComponent(anon),
  publicJoin:(rid)=>BACKEND_BASE+'/v1/public/join?room_id='+encodeURIComponent(rid),
  leave:(rid,anon)=>BACKEND_BASE+'/v1/rooms/leave?room_id='+encodeURIComponent(rid)+'&anon_id='+encodeURIComponent(anon),
  list:(rid,l=100)=>BACKEND_BASE+`/v1/messages/list?room_id=${encodeURIComponent(rid)}&limit=${l}`,
  post:(rid)=>BACKEND_BASE+'/v1/messages/post?room_id='+encodeURIComponent(rid),
  upload:(rid)=>BACKEND_BASE+'/v1/files/upload?room_id='+encodeURIComponent(rid),
  fileGet:(filePath)=>BACKEND_BASE+filePath, // content has /v1/files/get?file_id=...
};
let anonId=new URLSearchParams(location.search).get('anon_id')||null;
let roomId=new URLSearchParams(location.search).get('room_id')||null;
let poll=null,last=0;
const $=id=>document.getElementById(id);
function chips(){ $('cAnon').textContent='Anon: '+(anonId||'—'); $('cRoom').textContent='Room: '+(roomId||'—'); }
function linkify(text){
  return text.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))
             .replace(/(https?:\/\/[^\s<]+)/g, '<a class="link" target="_blank" rel="noopener" href="$1">$1</a>');
}
function renderMessage(m){
  const me = (m.sender_anon_id===anonId);
  const d = document.createElement('div'); d.className='bub'+(me?' me':'');
  let body = '';
  if(m.msg_type==='file'){
    const href = API.fileGet(m.content);
    body = `<div class="fileName"><a class="link" target="_blank" rel="noopener" href="${href}">Download file</a></div>`;
  }else{
    body = `<div>${linkify(m.content)}</div>`;
  }
  d.innerHTML = `${body}<div class="meta">${me?'You':m.sender_anon_id}</div>`;
  $('chat').appendChild(d); $('chat').scrollTop=$('chat').scrollHeight;
}
function pushSys(t){ const d=document.createElement('div'); d.className='sys'; d.textContent=t; $('chat').appendChild(d); $('chat').scrollTop=$('chat').scrollHeight; }
async function ensureAnon(){ if(anonId) return; const r=await fetch(API.anon); const j=await r.json(); anonId=j.id; const u=new URL(location.href); u.searchParams.set('anon_id',anonId); history.replaceState(null,'',u.toString()); chips(); }
function enableChat(on){ $('msg').disabled=!on; $('btnSend').disabled=!on; $('btnLeave').disabled=!on; $('btnFile').disabled=!on; }
async function createGroup(){
  $('err').textContent=''; await ensureAnon();
  const r=await fetch(API.publicCreate(anonId),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:$('roomName').value||null})});
  if(!r.ok){ $('err').textContent='Create failed'; return; }
  const j=await r.json(); roomId=j.room_id; $('shareURL').value=j.share_url; chips();
  await joinGroup(roomId, false);
}
async function joinGroup(rid, announce=true){
  await ensureAnon();
  const r=await fetch(API.publicJoin(rid),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({anon_id:anonId})});
  if(!r.ok){ $('err').textContent='Join failed'; return; }
  roomId=rid; chips(); enableChat(true); if(announce) pushSys('Joined'); startPoll();
}
async function leave(){
  if(!roomId) return; try{ await fetch(API.leave(roomId,anonId),{method:'POST'});}catch(_){}
  stopPoll(); $('chat').innerHTML=''; enableChat(false); const prev=roomId; roomId=null; chips(); pushSys('Left #'+prev);
}
async function sendText(){
  const t=$('msg').value.trim(); if(!t||!roomId) return;
  const r=await fetch(API.post(roomId),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({anon_id:anonId,msg_type:'text',content:t})});
  if(!r.ok){ $('err').textContent='Send failed'; return; }
  $('msg').value=''; await refresh();
}
async function uploadFile(file){
  if(!file){return;}
  if(file.size> (1024*1024)){ $('err').textContent='File too large (max 1MB)'; return; }
  const fd=new FormData(); fd.append('anon_id', anonId); fd.append('f', file);
  const r=await fetch(API.upload(roomId),{method:'POST',body:fd});
  if(!r.ok){ $('err').textContent='Upload failed (max 1MB, must be in-room)'; return; }
  await refresh();
}
async function list(){ if(!roomId) return []; const r=await fetch(API.list(roomId)); if(!r.ok) return []; return r.json(); }
async function refresh(){ const msgs=await list(); if(msgs.length===last) return; $('chat').innerHTML=''; msgs.forEach(renderMessage); last=msgs.length; }
function startPoll(){ stopPoll(); refresh(); poll=setInterval(refresh,2000); }
function stopPoll(){ if(poll){clearInterval(poll); poll=null;} }
$('btnCreate').addEventListener('click', createGroup);
$('btnCopy').addEventListener('click', ()=>{ navigator.clipboard?.writeText($('shareURL').value||''); });
$('btnSend').addEventListener('click', sendText);
$('msg').addEventListener('keydown', e=>{ if(e.key==='Enter') sendText(); });
$('btnLeave').addEventListener('click', leave);
$('btnFile').addEventListener('click', ()=> $('file').click());
$('file').addEventListener('change', e=> uploadFile(e.target.files[0]));
(async()=>{ try{ chips(); await ensureAnon(); chips(); const rid=new URLSearchParams(location.search).get('room_id'); if(rid){ await joinGroup(rid); } else { pushSys('Create a new public group or open a shared group URL.'); } }catch(e){ $('err').textContent=e.message; }})();
</script>
</body>
</html>
